# LifeOS Copilot Instructions

## Architecture Overview

LifeOS is a **monorepo** containing a mobile app with backend API:

- **`lifeos_backend/`** — Laravel 12 REST API (PHP 8.2+)
- **`lifeos_client/`** — Flutter mobile app (Dart 3.8.1+)

**Communication pattern**: Flutter client communicates ONLY via HTTP REST API with Laravel backend. No direct database access from client.

## Backend (lifeos_backend/)

### Tech Stack
- Laravel 12 with PHP 8.2
- Database: SQLite (default), supports MySQL/PostgreSQL
- Auth: Session-based (web guard), **no Sanctum/Passport installed yet**
- Frontend assets: Vite + TailwindCSS 4 (for any admin views)
- Queue: Database driver (local dev)

### Key Developer Workflows

**Setup**:
```bash
cd lifeos_backend
composer run setup  # Installs deps, copies .env, generates key, migrates, builds assets
```

**Development** (all services in one command):
```bash
composer run dev  # Runs: Laravel server, queue worker, Pail logs, Vite (concurrently)
```

**Testing**:
```bash
composer run test  # Clears config cache, runs PHPUnit
```

### Project Structure Patterns

- **No API routes yet**: `routes/api.php` doesn't exist. When creating API endpoints:
  1. Add `api: __DIR__.'/../routes/api.php'` to `bootstrap/app.php` routing config
  2. Create `routes/api.php` with `/api` prefix
  3. Install Sanctum if token auth needed: `composer require laravel/sanctum`, add `HasApiTokens` trait to User model

- **Controllers**: Use invokable controllers or resource controllers in `app/Http/Controllers/`
- **Services**: Extract business logic into service classes (not generated by default, create manually)
- **Resources**: Use API Resources for consistent JSON responses (`php artisan make:resource`)
- **Requests**: Use Form Requests for validation (`php artisan make:request`)

### Architecture Conventions

- **API responses**: Return JSON using Laravel API Resources
- **Authentication**: When implementing API auth, use Laravel Sanctum token-based auth
- **Validation**: Always use Form Request classes, never validate in controllers
- **Business logic**: Controllers should be thin—delegate to service classes
- **Database**: Use migrations for schema, factories for testing, seeders for initial data

### Configuration Notes

- Default DB is SQLite (`database/database.sqlite`)
- Queue runs on database driver (check `queue:listen` in dev script)
- Session stored in database (see `SESSION_DRIVER=database`)
- Logs via Pail in dev (real-time log viewer)

## Client (lifeos_client/)

### Tech Stack
- Flutter SDK 3.8.1+
- Dart 3.8.1+
- Minimal dependencies (only `cupertino_icons`)
- **No state management library installed yet** (BLoC/Cubit/Riverpod to be added)
- **No HTTP client installed yet** (http/dio to be added)

### Development Workflows

**Run app**:
```bash
cd lifeos_client
flutter run  # Pick device/simulator
```

**Tests**:
```bash
flutter test
```

**Build**:
```bash
flutter build apk      # Android
flutter build ios      # iOS (macOS only)
flutter build web      # Web
```

### Architecture Patterns (To Implement)

When building features, follow **Clean Architecture**:

```
lib/
  features/
    feature_name/
      data/          # API clients, DTOs, repositories impl
      domain/        # Entities, repository interfaces, use cases
      presentation/  # BLoC/Cubit, UI widgets
```

### Key Conventions

- **State management**: Use BLoC/Cubit pattern (install `flutter_bloc` when needed)
- **HTTP client**: Use `dio` package for API calls (not installed yet)
- **API models**: Keep DTOs in `data/` layer, map to domain entities
- **Dependency injection**: Use `get_it` or `provider` for service location
- **Naming**: Match backend API response keys exactly in DTO classes

### Not Yet Configured

- No environment config (API base URL) — add `flutter_dotenv` or similar
- No routing library — add `go_router` when multi-screen app needed
- No local storage — add `shared_preferences` or `hive` when needed

## Cross-Component Workflow

### Adding a New API Feature

1. **Backend** (`lifeos_backend/`):
   - Create migration: `php artisan make:migration`
   - Create model: `php artisan make:model -mfr` (with migration, factory, resource)
   - Create controller: `php artisan make:controller --api`
   - Create Form Request: `php artisan make:request`
   - Create API Resource: `php artisan make:resource`
   - Add route in `routes/api.php`
   - Test: Write feature test in `tests/Feature/`

2. **Client** (`lifeos_client/`):
   - Create feature folder structure: `lib/features/feature_name/{data,domain,presentation}/`
   - Create DTO matching API response (in `data/models/`)
   - Create repository interface (in `domain/`)
   - Create repository implementation with API calls (in `data/`)
   - Create BLoC/Cubit (in `presentation/`)
   - Create UI widgets (in `presentation/pages/` or `presentation/widgets/`)
   - Write widget tests

### Example: User Login

**Backend** (`POST /api/auth/login`):
```php
// app/Http/Controllers/Auth/LoginController.php
// app/Http/Requests/LoginRequest.php (validates email, password)
// app/Http/Resources/UserResource.php (returns user + token)
```

**Client**:
```dart
// lib/features/auth/data/models/login_response_dto.dart
// lib/features/auth/domain/repositories/auth_repository.dart (interface)
// lib/features/auth/data/repositories/auth_repository_impl.dart (API call)
// lib/features/auth/presentation/bloc/auth_bloc.dart
// lib/features/auth/presentation/pages/login_page.dart
```

## Testing

- **Backend**: Feature tests for API endpoints, Unit tests for services
- **Client**: Widget tests for UI, Unit tests for BLoC/repositories
- Mock API responses in Flutter tests using `mockito` or `mocktail`

## Common Gotchas

- **Backend**: Remember to clear config cache after .env changes: `php artisan config:clear`
- **Backend**: API routes need CSRF exemption (handled automatically in `bootstrap/app.php` when api routes added)
- **Client**: Hot reload works for UI, hot restart needed for state changes or dependency injection
- **Client**: iOS builds require macOS and Xcode installed
- **Monorepo**: Always specify correct directory (`cd lifeos_backend` or `cd lifeos_client`) before commands

## Production Considerations

- Backend: Use MySQL/PostgreSQL instead of SQLite
- Backend: Configure queue driver (Redis, SQS, etc.)
- Backend: Set `APP_DEBUG=false`, rotate `APP_KEY`
- Client: Configure base API URL via environment variables
- Client: Add error tracking (Sentry, Firebase Crashlytics)
- Both: Implement proper logging and monitoring

## Quick Reference

**Start backend dev server**:
```bash
cd lifeos_backend && composer run dev
```

**Start Flutter app**:
```bash
cd lifeos_client && flutter run
```

**Run all tests**:
```bash
cd lifeos_backend && composer run test
cd lifeos_client && flutter test
```
